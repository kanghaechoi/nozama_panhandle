{% extends '/pages/layout.html' %}

{% block content %}
    <div class="container-fluid" style="height: 80px;">
        <div class="row">
            <p class="h1">Unloading Package</p>
        </div>
    </div>

    <div class="container-fluid" style="height: 220px;">
        <div class="row">
	        <p class="h2">Current Delivery</p>
        </div>
        <table class="table table-borderless" style="height: 150px; text-align: center;">
	        <tbody>
                <tr>
	                <td id="curr_addr" class="w-25 align-middle bg-secondary rounded">
                        <p class="h2 text-white">{{current_unload.address}}</p>
                    </td>
	                <td id="curr_red" class="w-25 align-middle bg-danger rounded">
                        <p class="h2 text-white">{{current_unload.red}}</p>
                    </td>
	                <td id="curr_green" class="w-25 align-middle bg-success rounded">
                        <p class="h2 text-white">{{current_unload.green}}</p>
                    </td>
	                <td id="curr_blue" class="w-25 align-middle bg-primary rounded">
                        <p class="h2 text-white">{{current_unload.blue}}</p>
                    </td>  
                </tr>
            </tbody>
	    </table>
        <div>
            <button class="btn btn-block" type="button" style="background-color: #bdbdbd; border-color: #ffc209; border-width: 2px;" onclick="myFunction()">
                <span class="align-bottom" style="color: #424242;">Package is delivered</span>
            </button>
        </div>
    </div>
    
    <div class="container-fluid" style="height: 500px;">
        <div class="row">
            <p class="h2">Next Delivery</p>
        </div>
	    <table id="next_table" class="table table-borderless" style="height: 150px; text-align: center;">
	        <tbody></tbody>
	    </table>
        <div>
            <button type="button" class="btn btn-block" style="background-color: #bdbdbd; border-color: #ffc209; border-width: 2px;" onclick="pageReloader()">
                <span class="align-bottom" style="color: #424242;">Reload</span>
            </button>
	    </div>
    </div>

	<script type="text/javascript">
	    $(function() {
	        {% for next in next_unload %}
	            var address = {{next.address}};
	            var red = {{next.red}};
	            var green = {{next.green}};
	            var blue = {{next.blue}};
	            $('#next_table > tbody').append('<tr><td class="w-25 align-middle table-secondary rounded"><p class="h2 text-black-50">' + address + '</p></td><td class="w-25 align-middle table-danger rounded"><p class="h2 text-black-50">' + red + '</p></td><td class="w-25 align-middle table-success rounded"><p class="h2 text-black-50">' + green + '</p></td><td class="w-25 align-middle table-primary rounded"><p class="h2 text-black-50">' + blue + '</p></td></tr>');
	        {% endfor %}
	    });
	</script>
	
	<script>
        var socket=io.connect('http://'+document.domain+':'+location.port+'/unloading');
        socket.on('connect', function(){
            console.log('Connected!');
        });
        socket.on('arrived', function(msg){
            alert('arrived');
        });
    
        socket.on('refresh', function(msg){
            console.log(msg);
            //$("#curr_addr").text(msg[0]['addr']);
       
            if(msg){
                $("#curr_addr").text(msg[0]['address']);
                $("#curr_red").text(msg[0]['red']);
                $("#curr_green").text(msg[0]['green']);
                $("#curr_blue").text(msg[0]['blue']);
                l=Object.keys(msg).length
            }
            else{
                $("#curr_addr").text("");
                $("#curr_red").text("");
                $("#curr_green").text("");
                $("#curr_blue").text("");
                l=0
            }
       
            $('#next_table > tbody').html("")
            for(i=1;i<l;i++){
                $('#next_table > tbody').append('<tr><td>' + msg[i]['address'] + '</td><td>' + msg[i]['red'] + '</td><td>' + msg[i]['green'] + '</td><td>' + msg[i]['blue'] + '</td></tr>');
            }
        });

	    function myFunction() {
		    socket.emit('button', 'clear ' + $("#curr_addr").text());
	    }

        function pageReloader() {
            if(!alert('{{current_unload.address}} arrived!')){
                window.location.reload();
            }
        }
	</script>
{% endblock %}
